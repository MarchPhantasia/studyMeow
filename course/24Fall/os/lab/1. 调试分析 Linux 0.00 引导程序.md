## 1.1. 实验目的

- 熟悉实验环境；
- 掌握如何手写 Bochs 虚拟机的配置文件；
- 掌握 Bochs 虚拟机的调试技巧；
- 掌握操作系统启动的步骤；

## 1.2. 实验内容

### 1.2.1. 掌握如何手写 Bochs 虚拟机的配置文件

#### 简介 `Bochs` 虚拟机的配置文件

Bochs 的配置文件是一个文本文件，通常命名为 `bochsrc.txt`，它包含了用于定义虚拟机的各种参数和选项的设置。这些参数和选项允许配置虚拟机的硬件、启动选项、内存分配、设备模拟和其他相关设置。

![image.png](https://raw.githubusercontent.com/MarchPhantasia/pic/main/hexoblog/20241119002454.png)

Bochs 的配置文件是一个文本文件，通常命名为 `bochsrc.txt`，它包含了 Bochs 虚拟机的各种设置和参数。这个配置文件对于定义虚拟机的硬件和软件环境非常重要。以下是 Bochs 虚拟机配置文件的一些常见部分和设置：

``` shell
# Configuration file for Bochs
# Sample bochsrc.txt file
 
# 设置了虚拟机使用的BIOS镜像文件，BIOS-bochs-latest 是BIOS镜像文件的名称
romimage: file=BIOS-bochs-latest
 
# 设置了虚拟机使用的VGA BIOS镜像文件，VGABIOS-lgpl-latest 是VGA BIOS镜像文件的名称
vgaromimage: file=VGABIOS-lgpl-latest
 
# 内存分配，在这里，虚拟机将被分配32兆字节（MB）的内存
megs: 32
 
# 设置了虚拟CPU的性能参数，ips代表每秒执行的指令数
cpu: ips=1000000
 
# 设置设备从软驱启动
boot: floppy
 
# 确保虚拟机配置文件中有正确配置的软驱设备
floppya: 1_44=floppy.img, status=inserted
 
# 设置设备从硬盘启动
boot: disk
 
# 确保虚拟机配置文件中正确配置了硬盘设备
ata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14, type=disk, path=harddisk.img, cylinders=1024, heads=16, spt=63
 
# 设置涉及虚拟机中的网络适配器
ne2k: ioaddr=0x300, irq=9
 
# 设置涉及虚拟机的日志和内部调试功能
debug: action=ignore, guest_os=dos, parport1=none
log: bochsout.txt
debug: internal
```

#### 如何设置从软驱启动

编辑 Bochs 的配置文件，通常是 `bochsrc.txt`

在配置文件中，找到以下行并确保正确设置启动选项为 `floppy，并` 确保虚拟机配置文件中有正确配置的软驱设备。

``` shell
boot: floppy
floppya: 1_44=a.img, status=inserted
```

#### 如何设置从硬盘启动

在配置文件中，找到以下行并确保正确设置启动选项为 `disk，并` 确保虚拟机配置文件中正确配置了硬盘设备。

``` sh
boot: disk
ata0-master: type=disk, path="harddisk.img", mode=flat, cylinders=1024, heads=16, spt=63
```

#### 如何设置调试选项

在配置文件中，找到调试选项的部分或在文件末尾添加以下内容以配置调试选项

``` sh
# 启用调试输出
debug: action="option_name", parameter="value"
 
# 例如，设置调试动作为打印所有调试信息
debug: action="debug", option="all"
 
# 可以设置其他选项，例如设置断点
debug: action="bpoint", name="my_breakpoint", type=address, addr=0x1234
```

> - action：指定要执行的调试操作，例如 "debug"（打印调试信息）或 "bpoint"（设置断点）等。
> - option：如果存在，可以设置特定的调试选项，例如 "all"（打印所有调试信息）。
> - name：为断点指定一个名称，用于标识它。
> - type：指定断点的类型，可以是 address（地址断点）等。
> - addr：如果设置了地址断点，指定要设置的地址。

保存配置文件并启动 Bochs 虚拟机。Bochs 将按照配置执行所选的调试操作。

### 1.2.2. 掌握 Bochs 虚拟机的调试技巧

- 如何单步跟踪？
- 如何设置断点进行调试？
- 如何查看通用寄存器的值？
- 如何查看系统寄存器的值？
- 如何查看内存指定位置的值？
- 如何查看各种表，如 `gdt` ，`idt` ，`ldt` 等？
- 如何查看 `TSS`？
- 如何查看栈中的内容？
- 如何在内存指定地方进行反汇编？

### 1.2.3. 计算机引导程序

1. 如何查看 `0x7c00` 处被装载了什么？
2. 如何把真正的内核程序从硬盘或软驱装载到自己想要放的地方;
3. 如何查看实模式的中断程序？
4. 如何静态创建 `gdt` 与 `idt` ？
5. 如何从实模式切换到保护模式？
6. 调试跟踪 `jmpi 0,8` ，解释如何寻址？

## 1.3. 实验报告

通过仔细的调试与跟踪程序，完成以下任务：

1. 请简述 `head.s` 的工作原理
2. 请记录 `head.s` 的内存分布状况，写明每个数据段，代码段，栈段的起始与终止的内存地址
3. 简述 `head.s` `57` 至 `62` 行在做什么？
4. 简述 `iret` 执行后， `pc` 如何找到下一条指令？
5. 记录 `iret` 执行前后，栈是如何变化的？
6. 当任务进行系统调用时，即 `int 0x80` 时，记录栈的变化情况。
